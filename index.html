<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–®–∫–æ–ª–∞ ‚Ññ1430 - –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è</title>
    <link rel="stylesheet" href="style.css">
    
    <!-- Backup CDN for HTML5 QR Code -->
    <script>
        window.addEventListener('error', function(e) {
            if (e.target.src && e.target.src.includes('html5-qrcode')) {
                console.warn('Primary CDN failed, loading backup...');
                var script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/html5-qrcode.min.js';
                script.crossOrigin = 'anonymous';
                document.head.appendChild(script);
            }
        }, true);
    </script>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="header-left">
                <div class="logo">
                    <span class="logo-icon">üè´</span>
                </div>
                <h1 class="header-title">–®–∫–æ–ª–∞ ‚Ññ1430</h1>
            </div>
            <div class="header-center">
                <div class="floor-controls">
                    <button class="floor-btn active" data-floor="1">–≠—Ç–∞–∂ 1</button>
                    <button class="floor-btn" data-floor="2">–≠—Ç–∞–∂ 2</button>
                    <button class="floor-btn" data-floor="3">–≠—Ç–∞–∂ 3</button>
                    <button class="add-floor-btn" title="–î–æ–±–∞–≤–∏—Ç—å —ç—Ç–∞–∂">+</button>
                </div>
            </div>
            <div class="header-right">
                <div class="quick-actions">
                    <button class="icon-btn" id="quickSave" title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞—Ä—Ç—É (Ctrl+S)">üíæ</button>
                    <button class="icon-btn" id="quickLoad" title="–ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ä—Ç—É (Ctrl+O)">üìÅ</button>
                </div>
                <button class="theme-toggle" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">
                    <span class="theme-icon">üåô</span>
                </button>
                <button class="menu-toggle" title="–ú–µ–Ω—é">
                    <span class="hamburger">‚ò∞</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-content">
                <!-- Mode Controls -->
                <div class="control-group">
                    <h3>–†–µ–∂–∏–º</h3>
                    <div class="mode-buttons">
                        <button class="mode-btn active" data-mode="view">–ü—Ä–æ—Å–º–æ—Ç—Ä</button>
                        <button class="mode-btn" data-mode="add">–î–æ–±–∞–≤–∏—Ç—å</button>
                        <button class="mode-btn" data-mode="edit">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                        <button class="mode-btn" data-mode="connect">–°–æ–µ–¥–∏–Ω–∏—Ç—å</button>
                        <button class="mode-btn" data-mode="delete">–£–¥–∞–ª–∏—Ç—å</button>
                        <button class="mode-btn" data-mode="move">–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å</button>
                    </div>
                </div>

                <!-- Node Type Selector -->
                <div class="control-group node-type-group" style="display: none;">
                    <h3>–¢–∏–ø –æ–±—ä–µ–∫—Ç–∞</h3>
                    <div class="node-type-buttons">
                        <button class="node-type-btn active" data-type="room">–ö–æ–º–Ω–∞—Ç–∞</button>
                        <button class="node-type-btn" data-type="stair">–õ–µ—Å—Ç–Ω–∏—Ü–∞</button>
                        <button class="node-type-btn" data-type="corridor">–ö–æ—Ä–∏–¥–æ—Ä</button>
                        <button class="node-type-btn" data-type="exit">–í—ã—Ö–æ–¥</button>
                    </div>
                </div>

                <!-- Zoom Controls -->
                <div class="control-group">
                    <h3>–ú–∞—Å—à—Ç–∞–±</h3>
                    <div class="zoom-controls">
                        <button class="zoom-btn" data-action="zoomIn">–£–≤–µ–ª–∏—á–∏—Ç—å</button>
                        <button class="zoom-btn" data-action="zoomOut">–£–º–µ–Ω—å—à–∏—Ç—å</button>
                        <button class="zoom-btn" data-action="resetView">–°–±—Ä–æ—Å–∏—Ç—å</button>
                    </div>
                </div>

                <!-- QR Scanner -->
                <div class="control-group">
                    <h3>–ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</h3>
                    <button class="qr-scanner-btn">–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR-–∫–æ–¥</button>
                </div>

                <!-- Route Planning -->
                <div class="control-group">
                    <h3>–ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞</h3>
                    <div class="route-controls">
                        <select class="form-control" id="startPoint">
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞—á–∞–ª—å–Ω—É—é —Ç–æ—á–∫—É</option>
                        </select>
                        <select class="form-control" id="endPoint">
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–Ω–µ—á–Ω—É—é —Ç–æ—á–∫—É</option>
                        </select>
                        <button class="route-btn" id="buildRoute">–ü–æ—Å—Ç—Ä–æ–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç</button>
                        <button class="route-btn" id="clearRoute">–û—á–∏—Å—Ç–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç</button>
                    </div>
                </div>

                <!-- Voice Navigation -->
                <div class="control-group">
                    <h3>–ì–æ–ª–æ—Å–æ–≤–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è</h3>
                    <div class="voice-controls">
                        <button class="voice-btn" id="startNavigation">–ù–∞—á–∞—Ç—å –Ω–∞–≤–∏–≥–∞—Ü–∏—é</button>
                        <button class="voice-btn" id="stopNavigation">–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
                        <button class="voice-btn" id="prevInstruction">–ù–∞–∑–∞–¥</button>
                        <button class="voice-btn" id="nextInstruction">–í–ø–µ—Ä–µ–¥</button>
                        <button class="voice-btn" id="repeatInstruction">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
                    </div>
                    <div class="current-instruction" id="currentInstruction"></div>
                </div>

                <!-- Voice Settings -->
                <div class="control-group">
                    <h3>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≥–æ–ª–æ—Å–∞</h3>
                    <div class="voice-settings">
                        <div class="form-group">
                            <label class="form-label" for="voiceSelect">–í—ã–±–æ—Ä –≥–æ–ª–æ—Å–∞</label>
                            <select class="form-control" id="voiceSelect">
                                <option value="">–ó–∞–≥—Ä—É–∑–∫–∞ –≥–æ–ª–æ—Å–æ–≤...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="voiceRate">
                                –°–∫–æ—Ä–æ—Å—Ç—å: <span id="rateValue">0.9</span>x
                            </label>
                            <input type="range" class="voice-slider" id="voiceRate" 
                                   min="0.5" max="2.0" step="0.1" value="0.9">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="voicePitch">
                                –¢–æ–Ω: <span id="pitchValue">1.0</span>
                            </label>
                            <input type="range" class="voice-slider" id="voicePitch" 
                                   min="0.5" max="2.0" step="0.1" value="1.0">
                        </div>
                        <button class="btn btn--outline btn--full-width" id="toggleSubtitles">
                            üìù –°—É–±—Ç–∏—Ç—Ä—ã: <span id="subtitleStatus">–í–∫–ª</span>
                        </button>
                    </div>
                </div>

                <!-- Map Management -->
                <div class="control-group">
                    <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ–π</h3>
                    <div class="map-controls">
                        <button class="map-btn" id="saveMap">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞—Ä—Ç—É</button>
                        <input type="file" id="loadMapFile" accept=".json" style="display: none;">
                        <button class="map-btn" id="loadMap">–ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ä—Ç—É</button>
                        <button class="map-btn" id="clearAll">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ</button>
                        
                        <div class="form-group" style="margin-top: 16px;">
                            <label class="form-label">–§–æ–Ω–æ–≤–∞—è —Å—Ö–µ–º–∞ —ç—Ç–∞–∂–∞</label>
                            <input type="file" id="floorPlanUpload" accept="image/*" style="display:none">
                            <button class="btn btn--outline btn--full-width" onclick="document.getElementById('floorPlanUpload').click()">
                                üìÅ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ö–µ–º—É
                            </button>
                            <div id="floorPlanInfo" style="font-size:12px;margin-top:4px;color:var(--color-text-secondary);"></div>
                            <button class="btn btn--outline btn--full-width" id="removeFloorPlan" style="margin-top:8px;display:none;">
                                üóëÔ∏è –£–¥–∞–ª–∏—Ç—å —Å—Ö–µ–º—É
                            </button>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="bgOpacity">
                                –ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å: <span id="bgOpacityValue">30</span>%
                            </label>
                            <input type="range" class="voice-slider" id="bgOpacity" 
                                   min="20" max="80" step="5" value="30">
                        </div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Canvas Container -->
        <div class="canvas-container">
            <canvas id="mapCanvas" width="800" height="600"></canvas>
            <div class="canvas-info">
                <span id="currentFloor">–≠—Ç–∞–∂ 1</span>
                <span id="zoomLevel">100%</span>
            </div>
        </div>
    </main>

    <!-- Modals -->
    <!-- QR Scanner Modal -->
    <div class="modal" id="qrModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ QR-–∫–æ–¥–∞</h2>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="camera-container">
                    <div id="qrReader"></div>
                    <div class="qr-status" id="qrStatus">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞–º–µ—Ä—ã...</div>
                </div>
                <div class="qr-result" id="qrResult"></div>
                <div class="qr-error" id="qrError"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn--secondary" id="stopQrScan">–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
                <button class="btn btn--primary" id="retryQrScan" style="display: none;">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É</button>
            </div>
        </div>
    </div>

    <!-- Node Edit Modal -->
    <div class="modal" id="editModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞</h2>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                    <input type="text" class="form-control" id="editName">
                </div>
                <div class="form-group">
                    <label class="form-label">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</label>
                    <textarea class="form-control" id="editInfo" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">QR-–∫–æ–¥</label>
                    <input type="text" class="form-control" id="editQrCode">
                </div>
                <div class="form-group" id="connectsToFloorGroup" style="display: none;">
                    <label class="form-label">–°–æ–µ–¥–∏–Ω—è–µ—Ç—Å—è —Å —ç—Ç–∞–∂–æ–º</label>
                    <select class="form-control" id="connectsToFloor">
                        <option value="">–ù–µ –≤—ã–±—Ä–∞–Ω–æ</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn--secondary" id="cancelEdit">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn btn--primary" id="saveEdit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- Password Modal -->
    <div class="modal" id="passwordModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å</h2>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">–ü–∞—Ä–æ–ª—å –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</label>
                    <input type="password" class="form-control" id="passwordInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
                    <div class="password-error" id="passwordError"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn--secondary" id="cancelPassword">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn btn--primary" id="submitPassword">–í–æ–π—Ç–∏</button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal" id="confirmModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</h2>
            </div>
            <div class="modal-body">
                <p id="confirmMessage"></p>
            </div>
            <div class="modal-footer">
                <button class="btn btn--secondary" id="cancelConfirm">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn btn--primary" id="confirmAction">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay" style="display:none;">
        <div class="spinner"></div>
        <p class="loading-text">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
    </div>

    <!-- Notifications -->
    <div class="notifications" id="notifications"></div>

    <!-- QR Scanner Library with backup -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js" onerror="this.onerror=null; this.src='https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/html5-qrcode.min.js'; console.log('Switching to backup CDN for html5-qrcode');"></script>
    <script src="app.js"></script>
    
    <!-- Enhanced Voice Settings Event Handlers -->
    <script>
        window.addEventListener('load', function() {
            const app = window.app;
            if (!app) return;
            
            const voiceSelect = document.getElementById('voiceSelect');
            const voiceRate = document.getElementById('voiceRate');
            const voicePitch = document.getElementById('voicePitch');
            const toggleSubtitles = document.getElementById('toggleSubtitles');
            
            const updateVoiceSelect = () => {
                if (app.voices && app.voices.length) {
                    voiceSelect.innerHTML = '';
                    app.voices.forEach((voice, i) => {
                        const opt = document.createElement('option');
                        opt.value = i;
                        opt.textContent = voice.name + ' (' + voice.lang + ')';
                        if (app.selectedVoice && voice.name === app.selectedVoice.name) {
                            opt.selected = true;
                        }
                        voiceSelect.appendChild(opt);
                    });
                }
            };
            
            setTimeout(updateVoiceSelect, 500);
            if (window.speechSynthesis) {
                window.speechSynthesis.addEventListener('voiceschanged', updateVoiceSelect);
            }
            
            if (voiceSelect) {
                voiceSelect.addEventListener('change', e => app.selectVoice(+e.target.value));
            }
            if (voiceRate) {
                voiceRate.addEventListener('input', e => {
                    const r = +e.target.value;
                    app.setVoiceRate(r);
                    document.getElementById('rateValue').textContent = r.toFixed(1);
                });
            }
            if (voicePitch) {
                voicePitch.addEventListener('input', e => {
                    const p = +e.target.value;
                    app.setVoicePitch(p);
                    document.getElementById('pitchValue').textContent = p.toFixed(1);
                });
            }
            if (toggleSubtitles) {
                toggleSubtitles.addEventListener('click', () => {
                    app.toggleSubtitles();
                    document.getElementById('subtitleStatus').textContent = app.showSubtitles ? '–í–∫–ª' : '–í—ã–∫–ª';
                });
            }
        });
    </script>
</body>
</html>